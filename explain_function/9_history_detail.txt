Xem Lá»‹ch Sá»­ Mua (HISTORY) - Chi Tiáº¿t Äáº§y Äá»§

=== 1. Tá»•ng Quan Chá»©c NÄƒng ===

Má»¥c Ä‘Ã­ch: User xem lá»‹ch sá»­ cÃ¡c item Ä‘Ã£ tháº¯ng Ä‘áº¥u giÃ¡ (mua Ä‘Æ°á»£c)

ThÃ´ng tin lÆ°u trá»¯:
- Thá»i gian tháº¯ng (timestamp Unix)
- NgÆ°á»i tháº¯ng (username)
- PhÃ²ng Ä‘áº¥u giÃ¡ (room_id)
- Item (item_id, biá»ƒn sá»‘)
- GiÃ¡ cuá»‘i cÃ¹ng (price)
- PhÆ°Æ¡ng thá»©c (TIMEOUT / BUY_NOW)

Quy trÃ¬nh:

                        Client (user)
                              â”‚
                      "HISTORY" (gá»­i lá»‡nh)
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Handler kiá»ƒm tra:    â”‚
                    â”‚ - Login?             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ send_history()       â”‚
                    â”‚ - Lock mutex         â”‚
                    â”‚ - Äá»c history.txt    â”‚
                    â”‚ - Filter by username â”‚
                    â”‚ - Format dá»¯ liá»‡u     â”‚
                    â”‚ - Unlock mutex       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    send(HISTORY_LIST + danh sÃ¡ch)
                               â”‚
                               â–¼
                    Client nháº­n & hiá»ƒn thá»‹


DÆ°á»›i Ä‘Ã¢y lÃ  **báº£n giáº£i thÃ­ch HISTORY Ä‘Æ°á»£c â€œchuáº©n hoÃ¡ láº¡iâ€** theo Ä‘Ãºng phong cÃ¡ch báº¡n Ä‘ang lÃ m:
â¡ **Ä‘Ãºng code â€“ Ä‘Ãºng luá»“ng â€“ Ä‘Ãºng tÆ° duy backend**, nhÆ°ng **gá»n, dá»… nhá»›, dá»… thuyáº¿t trÃ¬nh / ghi bÃ¡o cÃ¡o**.

---

# HISTORY â€“ Xem Lá»‹ch Sá»­ Mua / Tháº¯ng Äáº¥u GiÃ¡

---

## 1. HISTORY dÃ¹ng Ä‘á»ƒ lÃ m gÃ¬?

* Cho **user Ä‘Ã£ login** xem **lá»‹ch sá»­ cÃ¡c item mÃ¬nh Ä‘Ã£ tháº¯ng**
* Chá»‰ hiá»ƒn thá»‹ **lá»‹ch sá»­ cá»§a chÃ­nh user**
* Äáº£m báº£o **privacy** (user khÃ´ng xem Ä‘Æ°á»£c lá»‹ch sá»­ ngÆ°á»i khÃ¡c)

ğŸ‘‰ ÄÃ¢y lÃ  **API read-only, cÃ¡ nhÃ¢n hÃ³a theo username**

---

## 2. Dá»¯ liá»‡u lá»‹ch sá»­ gá»“m nhá»¯ng gÃ¬?

Má»—i record trong lá»‹ch sá»­ chá»©a:

* â± Thá»i gian tháº¯ng (Unix timestamp)
* ğŸ‘¤ Username ngÆ°á»i tháº¯ng
* ğŸ  Room ID
* ğŸ“¦ Item ID + biá»ƒn sá»‘
* ğŸ’° GiÃ¡ cuá»‘i cÃ¹ng
* ğŸ›’ PhÆ°Æ¡ng thá»©c:

  * `BUY_NOW`
  * `TIMEOUT`

ğŸ‘‰ ÄÃ¢y lÃ  **audit log cá»§a giao dá»‹ch thÃ nh cÃ´ng**

---

## 3. Luá»“ng tá»•ng quÃ¡t (1 cÃ¢u)

> User gá»­i `HISTORY` â†’ server Ä‘á»c `history.txt` â†’ lá»c theo username â†’ format â†’ gá»­i danh sÃ¡ch

---

## 4. Handler xá»­ lÃ½ HISTORY (vai trÃ² Ä‘iá»u phá»‘i)

```c
else if (strncmp(buffer, "HISTORY", 7) == 0) {
    if (strlen(username) == 0)
        send(client_sock, "NEED_LOGIN\n", 11, 0);
    else
        send_history(client_sock, username);
}
```

### Ã nghÄ©a:

1. **So khá»›p lá»‡nh**

   * KhÃ´ng cÃ³ tham sá»‘ â†’ Ä‘Æ¡n giáº£n
2. **Kiá»ƒm tra login**

   * ChÆ°a login â†’ `NEED_LOGIN`
3. **Gá»i send_history()**

   * Truyá»n socket + username
   * KhÃ´ng kiá»ƒm tra admin (user thÆ°á»ng dÃ¹ng)

ğŸ‘‰ Handler **khÃ´ng Ä‘á»c file**, chá»‰ Ä‘iá»u hÆ°á»›ng

---

## 5. send_history() â€“ trÃ¡i tim cá»§a HISTORY

### Nhiá»‡m vá»¥ chÃ­nh:

* Äá»c file `history.txt`
* Lá»c Ä‘Ãºng user
* Format dá»¯ liá»‡u dá»… Ä‘á»c
* Gá»­i vá» client

---

### 5.1 Lock mutex â€“ cá»±c ká»³ quan trá»ng

```c
pthread_mutex_lock(&history_mutex);
```

* Báº£o vá»‡ file I/O
* TrÃ¡nh:

  * Äá»c khi Ä‘ang ghi
  * Dá»¯ liá»‡u bá»‹ cáº¯t ná»­a dÃ²ng

ğŸ‘‰ ÄÃ¢y lÃ  **Ä‘iá»ƒm backend ráº¥t â€œÄƒn tiá»nâ€**

---

### 5.2 Má»Ÿ file

```c
FILE *f = fopen("history.txt", "r");
```

* Mode `"r"`: chá»‰ Ä‘á»c
* Náº¿u file chÆ°a tá»“n táº¡i â†’ `HISTORY_EMPTY`

---

### 5.3 Khá»Ÿi táº¡o message

```c
char msg[4096] = "HISTORY_LIST\n";
int found = 0;
```

* 4096 byte â†’ Ä‘á»§ cho nhiá»u record
* `found`: cá» kiá»ƒm tra cÃ³ dá»¯ liá»‡u khÃ´ng

---

### 5.4 Äá»c tá»«ng dÃ²ng trong file

```c
while (fscanf(...) == 7)
```

Má»—i dÃ²ng cÃ³ format:

```
timestamp username room_id item_id plate price method
```

VÃ­ dá»¥:

```
1764381229 user1 1 7 29B11111 500 TIMEOUT
```

---

### 5.5 Filter theo username (privacy)

```c
if (strcmp(u, username) == 0)
```

* User **chá»‰ tháº¥y lá»‹ch sá»­ cá»§a chÃ­nh mÃ¬nh**
* KhÃ´ng cÃ³ cÃ¡ch xem lá»‹ch sá»­ ngÆ°á»i khÃ¡c

ğŸ‘‰ Privacy Ä‘Æ°á»£c Ä‘áº£m báº£o báº±ng **logic filter**, khÃ´ng pháº£i permission phá»©c táº¡p

---

### 5.6 Format timestamp cho con ngÆ°á»i Ä‘á»c

```c
localtime() + strftime()
```

* Unix timestamp â†’ `"YYYY-MM-DD HH:MM:SS"`
* Dá»… Ä‘á»c, dá»… debug

---

### 5.7 Format tá»«ng dÃ²ng hiá»ƒn thá»‹

```c
"%s | Room %d | Item %d | %s | Price %d | %s\n"
```

VÃ­ dá»¥:

```
2024-12-29 10:20:29 | Room 1 | Item 7 | 29B11111 | Price 500 | TIMEOUT
```

---

### 5.8 Kiá»ƒm tra buffer overflow

```c
if (strlen(msg) + strlen(line) < sizeof(msg) - 1)
```

* TrÃ¡nh ghi trÃ n bá»™ nhá»›
* Náº¿u quÃ¡ nhiá»u record â†’ bá» bá»›t (fail-safe)

---

### 5.9 Káº¿t thÃºc

* ÄÃ³ng file
* Unlock mutex
* Náº¿u `found == 0` â†’ `HISTORY_EMPTY`
* `send()` toÃ n bá»™ message

---

## 6. append_history() â€“ nÆ¡i lá»‹ch sá»­ Ä‘Æ°á»£c táº¡o ra

### Khi nÃ o Ä‘Æ°á»£c gá»i?

Chá»‰ khi **item Ä‘Æ°á»£c bÃ¡n thÃ nh cÃ´ng**

---

### 6.1 BUY_NOW

```c
append_history(username, room_id, it, "BUY_NOW");
```

* User chá»§ Ä‘á»™ng mua ngay
* Ghi lá»‹ch sá»­ ngay láº­p tá»©c

---

### 6.2 TIMEOUT

```c
append_history(it->leader, r->id, it, "TIMEOUT");
```

* Timer háº¿t
* CÃ³ leader â†’ ghi lá»‹ch sá»­
* KhÃ´ng cÃ³ leader â†’ bá» qua

---

### 6.3 append_history() lÃ m gÃ¬?

1. Lock mutex
2. Má»Ÿ `history.txt` á»Ÿ mode `"a"`
3. Láº¥y timestamp hiá»‡n táº¡i
4. `fprintf()` thÃªm 1 dÃ²ng
5. ÄÃ³ng file + unlock

ğŸ‘‰ **Append-only log** â€“ Ä‘Æ¡n giáº£n, bá»n, dá»… debug

---

## 7. Äá»‹nh dáº¡ng pháº£n há»“i HISTORY

### CÃ³ dá»¯ liá»‡u:

```
HISTORY_LIST
2024-12-29 10:20:29 | Room 1 | Item 7 | 29B11111 | Price 500 | TIMEOUT
2025-01-02 15:30:00 | Room 2 | Item 3 | 30A12345 | Price 1000 | BUY_NOW
```

### KhÃ´ng cÃ³ dá»¯ liá»‡u:

```
HISTORY_EMPTY
```

---

## 8. Ã nghÄ©a thiáº¿t káº¿ (ráº¥t quan trá»ng)

* HISTORY **khÃ´ng phá»¥ thuá»™c room**
* HISTORY **khÃ´ng phá»¥ thuá»™c join**
* HISTORY **Ä‘á»c tá»« file, khÃ´ng tá»« memory**

ğŸ‘‰ Lá»‹ch sá»­ **khÃ´ng máº¥t khi restart server**

---

## 9. CÃ¡c váº¥n Ä‘á» tiá»m áº©n (Ä‘Ãºng kiá»ƒu bÃ i há»‡ thá»‘ng)

1. ğŸ“ˆ File history.txt phÃ¬nh to
2. ğŸ“¦ Buffer giá»›i háº¡n (4096 byte)
3. âŒ KhÃ´ng cÃ³ phÃ¢n trang
4. âŒ KhÃ´ng xÃ³a lá»‹ch sá»­

ğŸ‘‰ NhÆ°ng vá»›i **Ä‘á»“ Ã¡n / project há»c táº­p** â†’ thiáº¿t káº¿ nÃ y **ráº¥t há»£p lÃ½**

---

## 10. CÃ¢u káº¿t luáº­n â€œÄ‘inhâ€

> **HISTORY lÃ  audit log chuáº©n backend**:
> append-only, thread-safe, privacy theo user, persistence qua file
> â†’ **KhÃ´ng pháº£i bÃ i toy, mÃ  lÃ  thiáº¿t káº¿ cÃ³ tÆ° duy há»‡ thá»‘ng**

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* Viáº¿t **báº£n thuyáº¿t trÃ¬nh 1â€“2 slide riÃªng cho HISTORY**
* So sÃ¡nh HISTORY nÃ y vá»›i **transaction history trong e-commerce tháº­t**
* Gá»£i Ã½ **chuyá»ƒn sang SQLite** (ráº¥t há»£p bÃ i nÃ y)

Báº¡n cá»© nÃ³i tiáº¿p ğŸ‘


=== 11. Flow Diagram ===

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User tháº¯ng item            â”‚
â”‚ (BUY_NOW hoáº·c TIMEOUT)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ append_history()      â”‚
     â”‚ â”œâ”€ Lock mutex         â”‚
     â”‚ â”œâ”€ Open "a" mode      â”‚
     â”‚ â”œâ”€ fprintf()          â”‚
     â”‚ â”œâ”€ Close file         â”‚
     â”‚ â””â”€ Unlock mutex       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (LÆ°u vÃ o history.txt)
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ history.txt          â”‚
    â”‚ ts u room item plate â”‚
    â”‚ price method         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (User gá»­i HISTORY)
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ send_history()       â”‚
    â”‚ â”œâ”€ Lock mutex        â”‚
    â”‚ â”œâ”€ Open "r" mode     â”‚
    â”‚ â”œâ”€ fscanf() loop     â”‚
    â”‚ â”œâ”€ Filter username   â”‚
    â”‚ â”œâ”€ Format lines      â”‚
    â”‚ â”œâ”€ Close file        â”‚
    â”‚ â”œâ”€ Unlock mutex      â”‚
    â”‚ â””â”€ send()            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Client nháº­n          â”‚
    â”‚ HISTORY_LIST         â”‚
    â”‚ 2024... | Room 1...  â”‚
    â”‚ 2025... | Room 2...  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


=== 12. Diá»…n Biáº¿n Chi Tiáº¿t Trong ChÆ°Æ¡ng TrÃ¬nh ===

1. User mua item thÃ nh cÃ´ng (BUY_NOW):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

handler.c â†’ BUY_NOW command
    â””â”€ Kiá»ƒm tra: login, room, item tá»“n táº¡i, giÃ¡ Ä‘á»§
    â””â”€ Cáº­p nháº­t: it->current_price, it->leader, it->status=1, it->auction_active=0
    â””â”€ save_items(room_id)
    â””â”€ append_history(username, room_id, it, "BUY_NOW")  â† Gá»i
    â””â”€ log_event()
    â””â”€ broadcast SOLD message

2. Timer háº¿t (TIMEOUT):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

auction.c â†’ auction_timer thread
    â””â”€ Duyá»‡t táº¥t cáº£ phÃ²ng & item
    â””â”€ Kiá»ƒm tra: end_time - now <= 0
    â””â”€ Cáº­p nháº­t: it->status=1, it->auction_active=0
    â””â”€ save_items(r->id)
    â””â”€ log_event()
    â””â”€ if (leader != "None") â†’ append_history(it->leader, r->id, it, "TIMEOUT")  â† Gá»i
    â””â”€ broadcast SOLD message

3. User xem lá»‹ch sá»­:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

handler.c â†’ HISTORY command
    â””â”€ Kiá»ƒm tra: login
    â””â”€ send_history(client_sock, username)  â† Gá»i
        â””â”€ Lock mutex
        â””â”€ Open history.txt
        â””â”€ Äá»c tá»«ng dÃ²ng
        â””â”€ Filter username
        â””â”€ Format & ná»‘i vÃ o msg
        â””â”€ Close file
        â””â”€ Unlock mutex
        â””â”€ send(msg)


=== 13. So SÃ¡nh CÃ¡c PhÆ°Æ¡ng Thá»©c ===

BUY_NOW:
â”€â”€â”€â”€â”€â”€â”€â”€
- User chá»§ Ä‘á»™ng mua ngay vá»›i giÃ¡ buy_now_price
- KhÃ´ng cáº§n Ä‘á»£i timer
- Tráº£ giÃ¡ Ä‘á»§ â†’ thÃ nh cÃ´ng ngay
- Ghi lá»‹ch sá»­: method = "BUY_NOW"

TIMEOUT:
â”€â”€â”€â”€â”€â”€â”€â”€
- Há»‡ thá»‘ng tá»± Ä‘á»™ng káº¿t thÃºc khi háº¿t giá»
- User bid trÆ°á»›c Ä‘Ã³ â†’ leader
- Timer cháº¡y 30s (hoáº·c extend thÃªm náº¿u cÃ³ bid cuá»‘i)
- Ghi lá»‹ch sá»­: method = "TIMEOUT"


=== 14. Váº¥n Äá» CÃ³ Thá»ƒ Xáº£y Ra ===

Váº¥n Ä‘á» 1: File history.txt lá»›n dáº§n
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Má»—i láº§n tháº¯ng â†’ thÃªm 1 dÃ²ng
Sau nhiá»u ngÃ y â†’ file ráº¥t lá»›n â†’ fscanf() cháº­m

Giáº£i phÃ¡p:
- Rotate log (history_old.txt, history_new.txt)
- Hoáº·c dÃ¹ng database (SQLite)

Váº¥n Ä‘á» 2: Buffer overflow náº¿u quÃ¡ nhiá»u record
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Buffer 4096 byte â†’ ~15-20 dÃ²ng (má»—i dÃ²ng ~200 byte)
Náº¿u user tháº¯ng 100 item â†’ chá»‰ hiá»ƒn thá»‹ 20 dÃ²ng Ä‘áº§u

Giáº£i phÃ¡p:
- TÄƒng buffer: char msg[16384]
- Hoáº·c phÃ¢n trang: HISTORY PAGE 1, HISTORY PAGE 2

Váº¥n Ä‘á» 3: KhÃ´ng thá»ƒ xÃ³a lá»‹ch sá»­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Hiá»‡n táº¡i khÃ´ng cÃ³ lá»‡nh DELETE_HISTORY
â†’ Lá»‹ch sá»­ tá»“n táº¡i mÃ£i mÃ£i

Giáº£i phÃ¡p:
- ThÃªm lá»‡nh DELETE_HISTORY (admin)
- Hoáº·c tá»± Ä‘á»™ng xÃ³a sau 1 nÄƒm


=== 15. Cáº£i Tiáº¿n CÃ³ Thá»ƒ LÃ m ===

1. ThÃªm filter theo phÃ²ng:
   HISTORY ROOM 1 â†’ Chá»‰ xem lá»‹ch sá»­ phÃ²ng 1

2. ThÃªm filter theo phÆ°Æ¡ng thá»©c:
   HISTORY BUY_NOW â†’ Chá»‰ xem lá»‹ch sá»­ BUY_NOW

3. ThÃªm filter theo thá»i gian:
   HISTORY LAST_7_DAYS â†’ Chá»‰ xem 7 ngÃ y gáº§n Ä‘Ã¢y

4. ThÃªm phÃ¢n trang:
   HISTORY PAGE 1 â†’ Xem trang 1 (10 dÃ²ng Ä‘áº§u)

5. ThÃªm tá»•ng tiá»n:
   HISTORY_LIST
   Total spent: 5000

6. ThÃªm detail cho tá»«ng item:
   HISTORY DETAIL 7 â†’ Xem chi tiáº¿t item 7 (ai bid, giÃ¡ tÄƒng tá»«ng bÆ°á»›c)

7. Admin xem táº¥t cáº£ lá»‹ch sá»­:
   HISTORY ALL (admin) â†’ Xem lá»‹ch sá»­ táº¥t cáº£ user

