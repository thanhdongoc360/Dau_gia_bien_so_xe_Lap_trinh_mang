Xem Danh SÃ¡ch PhÃ²ng (LIST_ROOMS) - Chi Tiáº¿t Chi Tiáº¿t

=== 1. Tá»•ng Quan Chá»©c NÄƒng ===

Má»¥c Ä‘Ã­ch: User (admin hoáº·c thÆ°á»ng) xem danh sÃ¡ch táº¥t cáº£ phÃ²ng Ä‘áº¥u giÃ¡ trong há»‡ thá»‘ng

ThÃ´ng tin cung cáº¥p:
- ID phÃ²ng
- TÃªn phÃ²ng
- Tráº¡ng thÃ¡i (OPEN / CLOSED)
- KhÃ´ng hiá»ƒn thá»‹: admin, members, items (chá»‰ trong LIST_ITEMS)

Quy trÃ¬nh:

                        Client (admin/user)
                              â”‚
                     "LIST_ROOMS" (gá»­i lá»‡nh)
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Handler kiá»ƒm tra:    â”‚
                    â”‚ - Login?             â”‚
                    â”‚ (khÃ´ng cáº§n admin)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ list_rooms()         â”‚
                    â”‚ - Duyá»‡t rooms[]      â”‚
                    â”‚ - Format dá»¯ liá»‡u     â”‚
                    â”‚ - Dá»«ng msg           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    send(ROOM_LIST + danh sÃ¡ch)
                               â”‚
                               â–¼
                    Client nháº­n & in ra


DÆ°á»›i Ä‘Ã¢y lÃ  **báº£n giáº£i thÃ­ch LIST_ROOMS Ä‘Æ°á»£c há»‡ thá»‘ng hoÃ¡ láº¡i â€“ gá»n, chuáº©n backend, dá»… nhá»›**, bÃ¡m **100% Ä‘Ãºng code & mÃ´ táº£ báº¡n Ä‘Æ°a**, khÃ´ng lan man.

---

# LIST_ROOMS â€“ Xem Danh SÃ¡ch PhÃ²ng Äáº¥u GiÃ¡ (Giáº£i thÃ­ch chuáº©n)

---

## 1. LIST_ROOMS dÃ¹ng Ä‘á»ƒ lÃ m gÃ¬?

* Cho **má»i user Ä‘Ã£ login** (admin hoáº·c thÆ°á»ng) xem:

  * ID phÃ²ng
  * TÃªn phÃ²ng
  * Tráº¡ng thÃ¡i: **OPEN / CLOSED**
* **KhÃ´ng lá»™ thÃ´ng tin nháº¡y cáº£m**:

  * KhÃ´ng admin
  * KhÃ´ng members
  * KhÃ´ng items

ğŸ‘‰ ÄÃ¢y lÃ  **API read-only, public (sau login)**

---

## 2. Äiá»u kiá»‡n Ä‘á»ƒ dÃ¹ng LIST_ROOMS

Chá»‰ cÃ³ **1 Ä‘iá»u kiá»‡n duy nháº¥t**:

* âœ… ÄÃ£ login

âŒ KhÃ´ng cáº§n:

* Admin
* Join phÃ²ng
* Tham sá»‘ bá»• sung

---

## 3. Handler xá»­ lÃ½ LIST_ROOMS (logic cá»‘t lÃµi)

```c
else if (strncmp(buffer, "LIST_ROOMS", 10) == 0) {
    if (strlen(username) == 0)
        send(client_sock, "NEED_LOGIN\n", 11, 0);
    else
        list_rooms(client_sock);
}
```

### Thá»© tá»± xá»­ lÃ½:

1. **So khá»›p lá»‡nh**

   * `strncmp(..., 10)`
   * Lá»‡nh khÃ´ng cÃ³ tham sá»‘ â†’ Ä‘Æ¡n giáº£n

2. **Kiá»ƒm tra login**

   * `username == ""` â†’ `NEED_LOGIN`

3. **Gá»i list_rooms()**

   * KhÃ´ng check role
   * Truyá»n socket Ä‘á»ƒ gá»­i dá»¯ liá»‡u

ğŸ‘‰ Handler **khÃ´ng build dá»¯ liá»‡u**, chá»‰ Ä‘iá»u phá»‘i

---

## 4. list_rooms() â€“ báº£n cháº¥t thá»±c sá»± lÃ m gÃ¬?

### TÃ³m táº¯t 1 cÃ¢u:

> Duyá»‡t `rooms[]` â†’ format tá»«ng phÃ²ng thÃ nh text â†’ ghÃ©p láº¡i â†’ gá»­i 1 láº§n qua socket

---

### 4.1 Khá»Ÿi táº¡o message

```c
char msg[1024] = "ROOM_LIST\n";
```

* 1024 byte: buffer chá»©a toÃ n bá»™ danh sÃ¡ch
* `"ROOM_LIST\n"` lÃ  **header protocol**
* Client nhÃ¬n header lÃ  biáº¿t Ä‘Ã¢y lÃ  danh sÃ¡ch phÃ²ng

---

### 4.2 Duyá»‡t tá»«ng phÃ²ng

```c
for (int i = 0; i < room_count; i++)
```

* `room_count` = sá»‘ phÃ²ng hiá»‡n cÃ³
* Chá»‰ Ä‘á»c dá»¯ liá»‡u, **khÃ´ng sá»­a**

---

### 4.3 Format tá»«ng dÃ²ng

```c
sprintf(line, "%d. %s [%s]\n",
        rooms[i].id,
        rooms[i].name,
        rooms[i].active ? "OPEN" : "CLOSED");
```

Káº¿t quáº£ má»—i dÃ²ng cÃ³ dáº¡ng:

```
<ID>. <TÃªn> [OPEN|CLOSED]
```

VÃ­ dá»¥:

```
2. room2 [CLOSED]
```

ğŸ‘‰ DÃ¹ng `active` lÃ m **single source of truth**

---

### 4.4 GhÃ©p chuá»—i

```c
strcat(msg, line);
```

* GhÃ©p tá»«ng dÃ²ng vÃ o `msg`
* Sau vÃ²ng láº·p â†’ `msg` chá»©a toÃ n bá»™ danh sÃ¡ch

---

### 4.5 Gá»­i 1 láº§n

```c
send(sock, msg, strlen(msg), 0);
```

ğŸ‘‰ **1 request â†’ 1 response**, khÃ´ng stream

---

## 5. Äá»‹nh dáº¡ng pháº£n há»“i (Protocol)

### Raw data gá»­i client:

```
ROOM_LIST
1. room1 [OPEN]
2. room2 [CLOSED]
3. room3 [OPEN]
```

### Ã nghÄ©a:

* DÃ²ng 1: Header
* CÃ¡c dÃ²ng sau: má»—i phÃ²ng = 1 dÃ²ng

ğŸ‘‰ Client chá»‰ cáº§n:

* Split theo `\n`
* Bá» dÃ²ng Ä‘áº§u
* In cÃ¡c dÃ²ng cÃ²n láº¡i

---

## 6. Ã nghÄ©a tráº¡ng thÃ¡i OPEN / CLOSED

### OPEN (`active = 1`)

* JOIN_ROOM Ä‘Æ°á»£c
* ADD_ITEM Ä‘Æ°á»£c
* BID / BUY_NOW Ä‘Æ°á»£c

### CLOSED (`active = 0`)

* âŒ JOIN_ROOM
* âŒ ADD_ITEM
* Chá»‰ xem Ä‘Æ°á»£c

ğŸ‘‰ LIST_ROOMS giÃºp user **quyáº¿t Ä‘á»‹nh cÃ³ join hay khÃ´ng**

---

## 7. Váº¥n Ä‘á» ká»¹ thuáº­t quan trá»ng (ráº¥t Ä‘Ã¡ng ghi Ä‘iá»ƒm)

### 7.1 Race condition (Ä‘iá»ƒm trá»« tiá»m áº©n)

* list_rooms() **khÃ´ng lock mutex**
* Náº¿u admin:

  * CREATE_ROOM
  * DELETE_ROOM
  * CLOSE_ROOM
* ÄÃºng lÃºc Ä‘ang duyá»‡t â†’ lá»—i

âœ… Giáº£i phÃ¡p chuáº©n:

```c
pthread_mutex_lock(&rooms_mutex);
list_rooms(sock);
pthread_mutex_unlock(&rooms_mutex);
```

---

### 7.2 Buffer overflow (nguy hiá»ƒm)

* 50 phÃ²ng Ã— ~50 byte â‰ˆ 2500 byte
* `msg[1024]` **khÃ´ng Ä‘á»§**

âœ… Giáº£i phÃ¡p:

* TÄƒng buffer (4096)
* Hoáº·c phÃ¢n trang (advanced)

---

## 8. TrÆ°á»ng há»£p Ä‘áº·c biá»‡t

### KhÃ´ng cÃ³ phÃ²ng

```
ROOM_LIST
```

* Há»£p lá»‡
* Client pháº£i xá»­ lÃ½ danh sÃ¡ch trá»‘ng

---

## 9. So sÃ¡nh nhanh (ráº¥t dá»… há»i trong váº¥n Ä‘Ã¡p)

| TiÃªu chÃ­   | LIST_ROOMS    | LIST_ITEMS |
| ---------- | ------------- | ---------- |
| Login      | âœ…             | âœ…          |
| Admin      | âŒ             | âŒ          |
| Join phÃ²ng | âŒ             | âœ…          |
| Pháº¡m vi    | ToÃ n há»‡ thá»‘ng | 1 phÃ²ng    |
| Dá»¯ liá»‡u    | PhÃ²ng         | Item       |

---

## 10. Báº£n cháº¥t thiáº¿t káº¿ (cÃ¢u káº¿t luáº­n máº¡nh)

> **LIST_ROOMS lÃ  API read-only, public-after-login, dÃ¹ng cho discovery**,
> giÃºp user **khÃ¡m phÃ¡ há»‡ thá»‘ng trÆ°á»›c khi tÆ°Æ¡ng tÃ¡c sÃ¢u**.

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* Chuáº©n hoÃ¡ pháº§n nÃ y thÃ nh **tÃ i liá»‡u bÃ¡o cÃ¡o ná»™p tháº§y**
* Viáº¿t **pseudo-code phiÃªn báº£n an toÃ n (mutex + pagination)**
* So sÃ¡nh LIST_ROOMS nÃ y vá»›i **API REST thá»±c táº¿ (GET /rooms)**

Chá»‰ cáº§n nÃ³i tiáº¿p ğŸ‘


=== 11. Flow Diagram ===

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LIST_ROOMS (user gá»­i)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ PARSE lá»‡nh       â”‚
     â”‚ (khÃ´ng cÃ³ param) â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Kiá»ƒm tra login?  â”‚
     â”‚ âœ“ username set   â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ list_rooms()           â”‚
     â”‚ â”œâ”€ msg="ROOM_LIST\n"   â”‚
     â”‚ â”œâ”€ for i in 0..count:  â”‚
     â”‚ â”‚  â”œâ”€ format line      â”‚
     â”‚ â”‚  â””â”€ append to msg    â”‚
     â”‚ â””â”€ send(sock, msg)     â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Client nháº­n        â”‚
     â”‚ Parse tá»«ng dÃ²ng    â”‚
     â”‚ In ra:             â”‚
     â”‚ ROOM_LIST          â”‚
     â”‚ 1. room1 [OPEN]    â”‚
     â”‚ 2. room2 [CLOSED]  â”‚
     â”‚ 3. room3 [OPEN]    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


=== 12. So SÃ¡nh LIST_ROOMS vs LIST_ITEMS ===

LIST_ROOMS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Xem táº¥t cáº£ phÃ²ng trong há»‡ thá»‘ng
- Chá»‰ cáº§n login (khÃ´ng cáº§n join phÃ²ng)
- Hiá»ƒn thá»‹: ID, TÃªn, Tráº¡ng thÃ¡i
- KhÃ´ng hiá»ƒn thá»‹: Admin, Members, Items

LIST_ITEMS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Xem item trong phÃ²ng mÃ  user Ä‘ang á»Ÿ
- Cáº§n login + JOIN_ROOM trÆ°á»›c
- Hiá»ƒn thá»‹: Item ID, Biá»ƒn sá»‘, GiÃ¡, BÆ°á»›c giÃ¡, Buy-now, Leader, Status, Thá»i gian cÃ²n
- Chá»‰ item trong phÃ²ng hiá»‡n táº¡i


=== 13. Cáº£i Tiáº¿n CÃ³ Thá»ƒ LÃ m ===

1. ThÃªm sá»‘ lÆ°á»£ng members hiá»ƒn thá»‹:
   "1. room1 [OPEN] - 2 members"

2. ThÃªm sá»‘ lÆ°á»£ng items:
   "1. room1 [OPEN] - 3 items"

3. PhÃ¢n trang: Náº¿u quÃ¡ nhiá»u phÃ²ng, gá»­i tá»«ng batch

4. Filter: LIST_ROOMS OPEN (chá»‰ xem OPEN) hoáº·c LIST_ROOMS CLOSED

5. Sort: LIST_ROOMS SORT_BY_ID hoáº·c SORT_BY_NAME

6. Hiá»ƒn thá»‹ admin: LIST_ROOMS ADMIN (xem ai quáº£n lÃ½)

