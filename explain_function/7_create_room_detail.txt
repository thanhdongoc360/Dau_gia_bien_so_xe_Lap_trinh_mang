Táº¡o PhÃ²ng Äáº¥u GiÃ¡ (CREATE_ROOM) - Chi Tiáº¿t Chi Tiáº¿t

=== 1. Tá»•ng Quan Quy TrÃ¬nh ===

Má»¥c Ä‘Ã­ch: Admin táº¡o má»™t phÃ²ng Ä‘áº¥u giÃ¡ má»›i Ä‘á»ƒ chá»©a cÃ¡c item cáº§n bÃ¡n

Quy trÃ¬nh:
                                    
                  Client (admin)
                      â”‚
            "CREATE_ROOM room1"
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Handler (parse)      â”‚
            â”‚ Kiá»ƒm tra:            â”‚
            â”‚ - Login?             â”‚
            â”‚ - Admin?             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ create_room(name, admin) â”‚
            â”‚ - Táº¡o Room object        â”‚
            â”‚ - GÃ¡n ID tÄƒng dáº§n        â”‚
            â”‚ - Set admin = owner      â”‚
            â”‚ - Set active = 1 (OPEN)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼             â–¼             â–¼
    save_rooms()   log_event()   send ROOM_CREATED
    (rooms.txt)    (server.log)  (pháº£n há»“i client)


DÆ°á»›i Ä‘Ã¢y lÃ  **báº£n giáº£i thÃ­ch â€œcháº¯t lá»c â€“ Ä‘Ãºng trá»ng tÃ¢m â€“ dá»… nhá»›â€** cho **CREATE_ROOM**, dá»±a Ä‘Ãºng vÃ o ná»™i dung báº¡n Ä‘Æ°a (khÃ´ng thÃªm giáº£ Ä‘á»‹nh thá»«a), theo phong cÃ¡ch **liá»‡t kÃª rÃµ rÃ ng tá»«ng Ã½** nhÆ° báº¡n thÃ­ch.

---

## 1. CREATE_ROOM dÃ¹ng Ä‘á»ƒ lÃ m gÃ¬?

* Cho **admin** táº¡o **má»™t phÃ²ng Ä‘áº¥u giÃ¡ má»›i**
* PhÃ²ng dÃ¹ng Ä‘á»ƒ:

  * Chá»©a item
  * Cho user JOIN
  * Thá»±c hiá»‡n BID / BUY_NOW
* PhÃ²ng **tá»“n táº¡i lÃ¢u dÃ i** (persist qua restart server)

---

## 2. Luá»“ng tá»•ng quÃ¡t (1 cÃ¢u)

> Admin gá»­i `CREATE_ROOM name` â†’ server kiá»ƒm tra quyá»n â†’ táº¡o Room trong memory â†’ lÆ°u file â†’ ghi log â†’ tráº£ ID cho client

---

## 3. Äiá»u kiá»‡n báº¯t buá»™c Ä‘á»ƒ CREATE_ROOM thÃ nh cÃ´ng

**Thiáº¿u 1 trong cÃ¡c Ä‘iá»u kiá»‡n sau â†’ fail ngay**

1. âœ… ÄÃ£ login
2. âœ… Role = `admin`
3. âœ… ChÆ°a vÆ°á»£t `MAX_ROOMS`
4. âœ… Mutex lock thÃ nh cÃ´ng (an toÃ n luá»“ng)

---

## 4. Handler xá»­ lÃ½ CREATE_ROOM (báº£n cháº¥t logic)

### Thá»© tá»± kiá»ƒm tra (ráº¥t quan trá»ng)

1. **Login chÆ°a?**

   * `username == ""` â†’ `NEED_LOGIN`
2. **CÃ³ pháº£i admin khÃ´ng?**

   * `role != "admin"` â†’ `PERMISSION_DENIED`
3. **Má»›i parse tÃªn phÃ²ng**
4. **Lock mutex**
5. **Gá»i create_room()**
6. **Unlock mutex**
7. **Tráº£ káº¿t quáº£ cho client**

ğŸ‘‰ Thá»© tá»± nÃ y giÃºp:

* KhÃ´ng tá»‘n tÃ i nguyÃªn khi user khÃ´ng Ä‘á»§ quyá»n
* TrÃ¡nh race condition khi nhiá»u admin táº¡o phÃ²ng cÃ¹ng lÃºc

---

## 5. create_room() thá»±c sá»± lÃ m gÃ¬? (bÃ³c tÃ¡ch tá»«ng hÃ nh Ä‘á»™ng)

### 1ï¸âƒ£ Kiá»ƒm tra giá»›i háº¡n

```c
if (room_count >= MAX_ROOMS) return -1;
```

* KhÃ´ng cho vÆ°á»£t quÃ¡ 50 phÃ²ng

---

### 2ï¸âƒ£ Chá»n slot lÆ°u phÃ²ng

```c
Room *r = &rooms[room_count];
```

* `rooms[]` lÃ  máº£ng
* `room_count` luÃ´n trá» tá»›i slot trá»‘ng tiáº¿p theo

---

### 3ï¸âƒ£ GÃ¡n ID tÄƒng dáº§n

```c
r->id = next_room_id++;
```

* ID **khÃ´ng phá»¥ thuá»™c vá»‹ trÃ­ máº£ng**
* ID **khÃ´ng reset khi restart server**

ğŸ‘‰ ÄÃ¢y lÃ  thiáº¿t káº¿ **chuáº©n server tháº­t**

---

### 4ï¸âƒ£ GÃ¡n dá»¯ liá»‡u phÃ²ng

* `name` â†’ tÃªn phÃ²ng
* `admin` â†’ owner (admin táº¡o)
* `active = 1` â†’ OPEN
* `member_count = 0`
* `item_count = 0`

ğŸ‘‰ PhÃ²ng má»›i **luÃ´n OPEN & trá»‘ng**

---

### 5ï¸âƒ£ Commit thay Ä‘á»•i

1. `room_count++` â†’ há»‡ thá»‘ng biáº¿t Ä‘Ã£ cÃ³ thÃªm phÃ²ng
2. `save_rooms()` â†’ lÆ°u bá»n vá»¯ng
3. `log_event()` â†’ audit / debug
4. `return r->id`

---

## 6. save_rooms() â€“ vÃ¬ sao dÃ¹ng mode `"w"`?

```c
fopen("rooms.txt", "w");
```

### Ã Ä‘á»“ thiáº¿t káº¿:

* **Ghi láº¡i toÃ n bá»™ tráº¡ng thÃ¡i hiá»‡n táº¡i**
* TrÃ¡nh:

  * PhÃ²ng bá»‹ xoÃ¡ nhÆ°ng váº«n cÃ²n trong file
  * Tráº¡ng thÃ¡i ACTIVE/CLOSED bá»‹ lá»‡ch

ğŸ‘‰ ÄÃ¢y lÃ  **snapshot strategy**, khÃ´ng pháº£i append log

---

## 7. Persistent â€“ Ä‘iá»ƒm ráº¥t â€œÄƒn tiá»nâ€ trong bÃ i nÃ y

* Server restart:

  * `load_rooms()` Ä‘á»c `rooms.txt`
  * KhÃ´i phá»¥c `rooms[]`
  * Set `next_room_id = max_id + 1`

ğŸ‘‰ KhÃ´ng bá»‹:

* Máº¥t phÃ²ng
* TrÃ¹ng ID
* Reset há»‡ thá»‘ng

---

## 8. Tráº¡ng thÃ¡i dá»¯ liá»‡u sau CREATE_ROOM (tÆ° duy há»‡ thá»‘ng)

### Memory

* `rooms[]` cÃ³ thÃªm pháº§n tá»­
* `room_count` tÄƒng
* `next_room_id` tÄƒng

### File

* `rooms.txt` Ä‘Æ°á»£c ghi láº¡i toÃ n bá»™

### Log

* CÃ³ timestamp + admin + room_id

### Client

* Nháº­n **ROOM_CREATED <id>**

ğŸ‘‰ **Memory + Disk + Log + Client** Ä‘á»u Ä‘á»“ng bá»™

---

## 9. CÃ¡c lá»—i thiáº¿t káº¿ tiá»m áº©n (nhÃ¬n lÃ  biáº¿t báº¡n hiá»ƒu sÃ¢u)

1. âš ï¸ `save_rooms()` fail nhÆ°ng váº«n return ID
   â†’ Memory â‰  Disk
   â†’ Restart server lÃ  máº¥t phÃ²ng
   âœ” NÃªn log error náº¿u fopen fail

2. âš ï¸ `strcpy()` khÃ´ng kiá»ƒm tra length
   âœ” NÃªn dÃ¹ng `strncpy`

3. âš ï¸ KhÃ´ng check trÃ¹ng tÃªn phÃ²ng
   âœ” CÃ³ thá»ƒ cho phÃ©p, nhÆ°ng nÃªn cÃ¢n nháº¯c UX

---

## 10. Káº¿t luáº­n 1 cÃ¢u (ráº¥t quan trá»ng)

> **CREATE_ROOM lÃ  má»™t luá»“ng CRUD chuáº©n server-side**, cÃ³:
>
> * Authorization
> * Concurrency control
> * Persistence
> * Logging
>   â†’ **ÄÃºng kiá»ƒu há»‡ thá»‘ng backend tháº­t, khÃ´ng pháº£i bÃ i táº­p giáº£**

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* Váº½ láº¡i **sequence diagram gá»n hÆ¡n**
* Chuáº©n hoÃ¡ thÃ nh **spec tÃ i liá»‡u ná»™p tháº§y**
* So sÃ¡nh thiáº¿t káº¿ nÃ y vá»›i **server Ä‘áº¥u giÃ¡ thá»±c táº¿** (AWS / microservice)

Chá»‰ cáº§n nÃ³i tiáº¿p ğŸ‘



=== 11. Flow Diagram ===

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE_ROOM room1 (admin1 gá»­i)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
         â”‚ PARSE     â”‚
         â”‚ name=room1â”‚
         â”‚ admin=admin1
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Kiá»ƒm tra login?  â”‚
         â”‚ âœ“ username set   â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Kiá»ƒm tra admin?  â”‚
         â”‚ âœ“ role="admin"   â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Lock mutex     â”‚
         â”‚ rooms_mutex    â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ create_room()          â”‚
         â”‚ â”œâ”€ Check room_count    â”‚
         â”‚ â”œâ”€ Assign ID = 1       â”‚
         â”‚ â”œâ”€ Set name = "room1"  â”‚
         â”‚ â”œâ”€ Set admin = "admin1"â”‚
         â”‚ â”œâ”€ Set active = 1      â”‚
         â”‚ â””â”€ room_count++        â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ save_rooms()   â”‚
         â”‚ (ghi file)     â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ log_event()      â”‚
         â”‚ (ghi log)        â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Unlock mutex   â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Pháº£n há»“i: ROOM_CREATED 1
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

